:toc:
:toc-placement!:
:toclevels: 4

= Structured date field data

toc::[]

== List of populated structured date fields

[source,sql]
----
SELECT DISTINCT HIER.NAME
FROM HIERARCHY HIER
INNER JOIN STRUCTUREDDATEGROUP SD ON SD.ID = HIER.ID
  AND SD.DATEDISPLAYDATE IS NOT NULL
WHERE HIER.PRIMARYTYPE = 'structuredDateGroup'
----

== Date details

Returns detailed date values for a given field.

Run the https://github.com/lyrasis/collectionspace-sql/blob/main/functions.adoc#deurn[DEURN function] before running the query.

=== Collectionobject
==== objectProductionDateGroup

This is a repeating field list. The parent is the collectionobject record

[source,sql]
----
with dates as (
  SELECT
    HIER.ID,
    REC.OBJECTNUMBER,
    concat(
      'https://domain/cspace/tenant/record/collectionobject/',
      ph.name
    ) as rec_url
  FROM
    HIERARCHY HIER
    INNER JOIN COLLECTIONOBJECTS_COMMON REC ON HIER.PARENTID = REC.ID
    inner join hierarchy ph on hier.parentid = ph.id
  WHERE
    HIER.PRIMARYTYPE = 'structuredDateGroup'
    AND HIER.NAME = 'collectionobjects_common:objectProductionDateGroupList'
)
SELECT
  D.OBJECTNUMBER,
  D.rec_url,
  SD.DATEDISPLAYDATE,
  SD.SCALARVALUESCOMPUTED,
  SD.DATEEARLIESTSCALARVALUE,
  SD.DATELATESTSCALARVALUE,
  SD.DATEEARLIESTSINGLEYEAR,
  SD.DATEEARLIESTSINGLEMONTH,
  SD.DATEEARLIESTSINGLEDAY,
  DEURN(SD.DATEEARLIESTSINGLEERA) as dateearliestsingleera,
  DEURN(SD.DATEEARLIESTSINGLECERTAINTY) as dateearliestsinglecertainty,
  DEURN(SD.DATEEARLIESTSINGLEQUALIFIER) as dateearliestsinglequalifier,
  SD.DATEEARLIESTSINGLEQUALIFIERVALUE,
  DEURN(
    SD.DATEEARLIESTSINGLEQUALIFIERUNIT
  ) as dateearliestsinglequalifierunit,
  SD.DATELATESTYEAR,
  SD.DATELATESTMONTH,
  SD.DATELATESTDAY,
  DEURN(SD.DATELATESTERA) as datelatestera,
  DEURN(SD.DATELATESTCERTAINTY) as datelatestcertainty,
  DEURN(SD.DATELATESTQUALIFIER) as datelatestqualifier,
  SD.DATELATESTQUALIFIERVALUE,
  DEURN(SD.DATELATESTQUALIFIERUNIT) as datelatestqualifierunit,
  SD.DATEPERIOD,
  SD.DATEASSOCIATION,
  SD.DATENOTE
FROM
  STRUCTUREDDATEGROUP SD
  INNER JOIN DATES D ON SD.ID = D.ID
WHERE
  SD.DATEDISPLAYDATE IS NOT NULL
----

==== assocDateGroup

This is a field inside a repeating field group. The parent is the group, so the collectionobject is 2 levels up.

[source,sql]
----
with dates as(
  SELECT
    HIER.ID,
    cc.objectnumber,
    concat(
      'https://domain/cspace/tenant/record/collectionobject/',
      objhier.name
    ) as rec_url
  FROM
    HIERARCHY HIER
    inner join hierarchy fghier on hier.parentid = fghier.id
    inner join hierarchy objhier on fghier.parentid = objhier.id
    inner join collectionobjects_common cc on fghier.parentid = cc.id
  WHERE
    HIER.PRIMARYTYPE = 'structuredDateGroup'
    AND HIER.NAME = 'assocStructuredDateGroup'
)
SELECT
  D.OBJECTNUMBER,
  d.rec_url,
  SD.DATEDISPLAYDATE,
  SD.SCALARVALUESCOMPUTED,
  SD.DATEEARLIESTSCALARVALUE,
  SD.DATELATESTSCALARVALUE,
  SD.DATEEARLIESTSINGLEYEAR,
  SD.DATEEARLIESTSINGLEMONTH,
  SD.DATEEARLIESTSINGLEDAY,
  DEURN(SD.DATEEARLIESTSINGLEERA) AS DATEEARLIESTSINGLEERA,
  DEURN(SD.DATEEARLIESTSINGLECERTAINTY) AS DATEEARLIESTSINGLECERTAINTY,
  DEURN(SD.DATEEARLIESTSINGLEQUALIFIER) AS DATEEARLIESTSINGLEQUALIFIER,
  SD.DATEEARLIESTSINGLEQUALIFIERVALUE,
  DEURN(
    SD.DATEEARLIESTSINGLEQUALIFIERUNIT
  ) AS DATEEARLIESTSINGLEQUALIFIERUNIT,
  SD.DATELATESTYEAR,
  SD.DATELATESTMONTH,
  SD.DATELATESTDAY,
  DEURN(SD.DATELATESTERA) AS DATELATESTERA,
  DEURN(SD.DATELATESTCERTAINTY) AS DATELATESTCERTAINTY,
  DEURN(SD.DATELATESTQUALIFIER) AS DATELATESTQUALIFIER,
  SD.DATELATESTQUALIFIERVALUE,
  DEURN(SD.DATELATESTQUALIFIERUNIT) AS DATELATESTQUALIFIERUNIT,
  SD.DATEPERIOD,
  SD.DATEASSOCIATION,
  SD.DATENOTE
FROM
  STRUCTUREDDATEGROUP SD
  INNER JOIN DATES D ON SD.ID = D.ID
WHERE
  SD.DATEDISPLAYDATE IS NOT NULL
----

=== Works
==== workDateGroup

[source,sql]
----
WITH VOCABS AS (
  SELECT
    HIER.NAME AS ID,
    REPLACE(
      REPLACE(
        SHORTIDENTIFIER, 'cona_work', 'cona'
      ),
      'work',
      'local'
    ) AS VOCAB
  FROM
    WORKAUTHORITIES_COMMON WC
    INNER JOIN HIERARCHY HIER ON WC.ID = HIER.ID
),
DATES AS (
  SELECT
    HIER.ID,
    DEURN(WC.REFNAME) AS TERM,
    CONCAT(
      'https://domain/cspace/tenant/record/work/',
      V.VOCAB, '/', PH.NAME
    ) AS RECURL
  FROM
    HIERARCHY HIER
    INNER JOIN WORKS_COMMON WC ON HIER.PARENTID = WC.ID
    INNER JOIN HIERARCHY PH ON HIER.PARENTID = PH.ID
    INNER JOIN VOCABS V ON WC.INAUTHORITY = V.ID
  WHERE
    HIER.PRIMARYTYPE = 'structuredDateGroup'
    AND HIER.NAME = 'works_common:workDateGroupList'
)
SELECT
  D.TERM,
  D.RECURL,
  SD.DATEDISPLAYDATE,
  SD.SCALARVALUESCOMPUTED,
  SD.DATEEARLIESTSCALARVALUE,
  SD.DATELATESTSCALARVALUE,
  SD.DATEEARLIESTSINGLEYEAR,
  SD.DATEEARLIESTSINGLEMONTH,
  SD.DATEEARLIESTSINGLEDAY,
  DEURN(SD.DATEEARLIESTSINGLEERA) AS DATEEARLIESTSINGLEERA,
  DEURN(SD.DATEEARLIESTSINGLECERTAINTY) AS DATEEARLIESTSINGLECERTAINTY,
  DEURN(SD.DATEEARLIESTSINGLEQUALIFIER) AS DATEEARLIESTSINGLEQUALIFIER,
  SD.DATEEARLIESTSINGLEQUALIFIERVALUE,
  DEURN(
    SD.DATEEARLIESTSINGLEQUALIFIERUNIT
  ) AS DATEEARLIESTSINGLEQUALIFIERUNIT,
  SD.DATELATESTYEAR,
  SD.DATELATESTMONTH,
  SD.DATELATESTDAY,
  DEURN(SD.DATELATESTERA) AS DATELATESTERA,
  DEURN(SD.DATELATESTCERTAINTY) AS DATELATESTCERTAINTY,
  DEURN(SD.DATELATESTQUALIFIER) AS DATELATESTQUALIFIER,
  SD.DATELATESTQUALIFIERVALUE,
  DEURN(SD.DATELATESTQUALIFIERUNIT) AS DATELATESTQUALIFIERUNIT,
  SD.DATEPERIOD,
  SD.DATEASSOCIATION,
  SD.DATENOTE
FROM
  STRUCTUREDDATEGROUP SD
  INNER JOIN DATES D ON SD.ID = D.ID
WHERE
  SD.DATEDISPLAYDATE IS NOT NULL
----
