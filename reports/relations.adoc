:toc:
:toc-placement!:
:toclevels: 4

= Relationship reports

toc::[]

== All objects with Computed current location values

Where there is no Computed current location, that field is null

[source,sql]
----
select
  cc.objectnumber,
  concat(
      'https://domain/cspace/tenant/record/all/',
      hier.name
    ) as rec_url,
  deurn(cc.computedcurrentlocation) as computedcurrentlocation
from collectionobjects_common cc
inner join misc on misc.id = cc.id and misc.lifecyclestate != 'deleted'
inner join hierarchy hier on cc.id = hier.id
----

== Procedure with count of related objects
=== Acquisitions with count of related objects

[source,sql]
----
with relct as (
  select
    hier.name,
    count(rel.objectcsid) as rels
  from
    public.relations_common rel
    inner join hierarchy hier on rel.subjectcsid = hier.name
  where
    rel.subjectdocumenttype = 'Acquisition'
    and rel.objectdocumenttype = 'CollectionObject'
  group by
    hier.name
)
select
  rec.acquisitionreferencenumber,
  concat(
    'https://domain/cspace/tenant/record/all/',
    hier.name
  ) as rec_url,
  rc.rels
from
  acquisitions_common rec
  inner join misc on misc.id = rec.id and misc.lifecyclestate != 'deleted'
  inner join hierarchy hier on rec.id = hier.id
  left outer join relct rc on hier.name = rc.name
----

=== Exhibitions with count of related objects

[source,sql]
----
with relct as (
  select
    hier.name,
    count(rel.objectcsid) as rels
  from
    public.relations_common rel
    inner join hierarchy hier on rel.subjectcsid = hier.name
  where
    rel.subjectdocumenttype = 'Exhibition'
    and rel.objectdocumenttype = 'CollectionObject'
  group by
    hier.name
)
select
  rec.exhibitionnumber,
  concat(
    'https://domain/cspace/tenant/record/all/',
    hier.name
  ) as rec_url,
  rc.rels
from
  exhibitions_common rec
  inner join misc on misc.id = rec.id and misc.lifecyclestate != 'deleted'
  inner join hierarchy hier on rec.id = hier.id
  left outer join relct rc on hier.name = rc.name
----

=== Groups with count of related objects

[source,sql]
----
with relct as (
  select
    hier.name,
    count(rel.objectcsid) as rels
  from
    public.relations_common rel
    inner join hierarchy hier on rel.subjectcsid = hier.name
  where
    rel.subjectdocumenttype = 'Group'
    and rel.objectdocumenttype = 'CollectionObject'
  group by
    hier.name
)
select
  rec.title,
  concat(
    'https://domain/cspace/tenant/record/all/',
    hier.name
  ) as rec_url,
  rc.rels
from
  groups_common rec
  inner join misc on misc.id = rec.id and misc.lifecyclestate != 'deleted'
  inner join hierarchy hier on rec.id = hier.id
  left outer join relct rc on hier.name = rc.name
----

=== Loansin with count of related objects

[source,sql]
----
with relct as (
  SELECT
    hier.name,
    count(rel.objectcsid) as rels
  FROM
    public.relations_common rel
    inner join hierarchy hier on rel.subjectcsid = hier.name
  where
    rel.subjectdocumenttype = 'Loanin'
    and rel.objectdocumenttype = 'CollectionObject'
  group by
    hier.name
)
select
  rec.loaninnumber,
  concat(
    'https://domain/cspace/tenant/record/all/',
    hier.name
  ) as rec_url,
  rc.rels
from
  loansin_common rec
  inner join misc on misc.id = rec.id and misc.lifecyclestate != 'deleted'
  inner join hierarchy hier on rec.id = hier.id
  left outer join relct rc on hier.name = rc.name
----

=== Movements (LMI) with count of related objects

[source,sql]
----
with relct as (
  SELECT
    hier.name,
    count(rel.objectcsid) as rels
  FROM
    public.relations_common rel
    inner join hierarchy hier on rel.subjectcsid = hier.name
  where
    rel.subjectdocumenttype = 'Movement'
    and rel.objectdocumenttype = 'CollectionObject'
  group by
    hier.name
)
select
  rec.movementreferencenumber,
  concat(
    'https://domain/cspace/tenant/record/all/',
    hier.name
  ) as rec_url,
  rc.rels
from
  movements_common rec
  inner join misc on misc.id = rec.id and misc.lifecyclestate != 'deleted'
  inner join hierarchy hier on rec.id = hier.id
  left outer join relct rc on hier.name = rc.name
----

== Procedures with count of related procedures

=== Loans In with count of related Insurance/Indemnity

[source,sql]
----
with relct as (
  SELECT
    hier.name,
    count(rel.objectcsid) as rels
  FROM
    relations_common rel
    inner join hierarchy hier on rel.subjectcsid = hier.name
  where
    rel.subjectdocumenttype = 'Loanin'
    and rel.objectdocumenttype = 'Insurance'
  group by
    hier.name
)
select
  rec.loaninnumber,
  concat(
    'https://domain/cspace/tenant/record/all/',
    hier.name
  ) as rec_url,
  rc.rels
from
  loansin_common rec
  inner join misc on misc.id = rec.id and misc.lifecyclestate != 'deleted'
  inner join hierarchy hier on rec.id = hier.id
  left outer join relct rc on hier.name = rc.name
----
